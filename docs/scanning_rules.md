# Papilio 扫描与资产关联规则

为了确保您的曲库能够被完美识别并关联封面、歌词及歌手图片，Papilio 后端执行了一套严谨的探测算法。了解这些规则可以帮助您更好地组织本地文件。

## 1. 音频文件识别
系统递归扫描 `MUSIC_DIR` 目录，目前支持以下格式：
- `flac`, `mp3`, `m4a`, `ogg`, `wav`

**元数据提取顺序**：
1. 优先读取嵌入在音频文件内部的 Tag（ID3v2, Vorbis, MP4 Tags）。
2. 如果缺少标题，则以文件名作为标题。
3. 如果缺少歌手/专辑，则标记为 "Unknown Artist" / "Unknown Album"。

## 2. 封面图片探测 (Cover Art)
对于每个专辑，系统按以下优先级寻找封面：
1. **嵌入封面**：音频文件内部嵌入的图片数据。
2. **外部文件**：在音频文件**同级目录**下寻找具有以下名称的文件（不区分大小写）：
   - `cover.jpg` / `.png` / `.jpeg` / `.webp`
   - `folder.jpg` / `.png`
   - `front.jpg`
   - `album.jpg`
   - `art.jpg`
   - **歌曲同名文件**：如 `江南.flac` 对应的 `江南.jpg`。

**注意**：如果一个目录下有多个图片且没有上述关键字，系统将默认选取该目录下唯一的图片作为封面。

## 3. 歌词关联 (Lyrics)
系统支持本地 Lrc 文件关联，探测逻辑如下：
1. **精确匹配**：寻找与音频文件同名但扩展名为 `.lrc` 的文件。
2. **模糊匹配**：如果同目录下仅存在一个 `.lrc` 文件，即使文件名不完全一致（如带了歌手后缀），也会自动完成关联。
3. **内嵌歌词**：从音频标签的 `USLT` 或 `LYRICS` 字段提取。

## 4. 歌手图片探测 (Artist Profile)
这是 Papilio 的特色功能，系统会尝试探测歌手级别的头像：
- **目录回溯**：系统从音轨目录向上回溯最多两层（通常是 `歌手/专辑` 结构）。
- **关键字触发**：在回溯目录中寻找 `folder.jpg`, `artist.jpg`, `logo.jpg` 等。
- **本地优先**：如果本地探测到图片，将不会再从云端抓取，节省流量并保护隐私。

## 5. 整理引擎规则 (Organize)
当您在后台触发“整理曲库文件”时：
- **同步迁移**：音频文件移动到新目录时，其关联的 `.lrc`, `.jpg`, `.pdf` 等资产会随之一同迁移。
- **目录清理**：空目录将被保留或按配置清理。
- **数据库同步**：数据库中的文件路径会即时更新，无需重新扫描。

---
建议将您的曲库组织为 `歌手/专辑/歌曲` 的结构，并在歌手目录下放置 `folder.jpg`，在专辑目录下放置 `cover.jpg` 以获得最佳视觉体验。
