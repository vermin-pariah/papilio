# ADR 0001: 附件上传与路径安全加固

## 状态
已接受 (Accepted)

## 上下文
在收尾审计阶段，发现 `papilio-server` 的头像上传功能（`upload_avatar` 和 `upload_artist_avatar`）存在严重的路径穿越风险和非法文件上传风险。原有逻辑仅依赖前端提供的后缀名，且未对保存路径进行净化。

## 决策
1.  **指纹校验 (Magic Number)**: 引入 `infer` 库。所有上传的二进制流必须通过文件头检测来确定真实的 MIME 类型。严禁仅凭扩展名判定文件合法性。
2.  **路径净化 (Sanitization)**: 引入 `sanitize-filename` 库。所有写入文件系统的文件名（如用户 ID、歌手 ID 拼接生成的名称）必须经过净化处理，移除 `../` 等目录跳转字符。
3.  **物理隔离**: 明确 `data/avatars` 为非执行、仅静态读取目录。

## 后果
- 极大地提升了系统对 RCE (远程代码执行) 和文件覆盖攻击的抵御能力。
- 增加了轻微的解析开销（读取前几个字节进行指纹匹配），但在高安全性要求的工业环境下是必须的。
- 规范了文件名生成逻辑，避免了不同操作系统（Windows vs Linux）对特殊字符处理不一致的问题。