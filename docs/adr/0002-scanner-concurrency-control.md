# ADR 0002: 扫描器并发冲突控制

## 状态
已接受 (Accepted)

## 上下文
Papilio 的 `Scanner` (元数据扫描) 和 `Organizer` (目录整理) 均为密集型 IO 任务，且深度依赖数据库状态。在旧版本中，缺乏对并发触发的保护，多个管理员同时触发扫描会导致数据库主键冲突、重复条目以及 DashMap 缓存竞态。

## 决策
1.  **全局单例锁**: 引入基于 `once_cell::sync::Lazy` 和 `tokio::sync::Mutex` 的 `SCAN_LOCK`。
2.  **尽早拦截 (Pre-check)**: 暴露 `is_scanning()` 方法。API 层在发起后台任务前必须先通过此锁进行预检。
3.  **互斥范围**: 锁定范围涵盖 `scan_directory` 和 `organize` 两类互斥操作。

## 后果
- 确保了扫描过程的原子性和数据库一致性。
- API 层现在能及时向前端反馈“已有任务正在进行”，提升了用户体验 (UX)。
- 简化了扫描逻辑，不再需要处理复杂的并发合并逻辑。